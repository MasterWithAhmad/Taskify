<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Taskify</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .settings-section {
            margin-bottom: 2rem;
        }
        .settings-card {
            transition: transform 0.2s;
        }
        .settings-card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-check2-square me-2"></i>Taskify
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                aria-label="Toggle navigation" title="Toggle navigation menu">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">
                            <i class="bi bi-speedometer2 me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/reports">
                            <i class="bi bi-graph-up me-1"></i>Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/calendar">
                            <i class="bi bi-calendar3 me-1"></i>Calendar
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/projects">
                            <i class="bi bi-folder me-1"></i>Projects
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" 
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle me-1"></i>Profile
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="/profile">
                                <i class="bi bi-person me-2"></i>My Profile
                            </a></li>
                            <li><a class="dropdown-item active" href="/settings">
                                <i class="bi bi-gear me-2"></i>Settings
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/help">
                                <i class="bi bi-question-circle me-2"></i>Help & Support
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-light ms-2" onclick="logout()" title="Logout">
                            <i class="bi bi-box-arrow-right"></i> Logout
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-4">
        <h2 class="mb-4">Settings</h2>
        
        <!-- Account Settings -->
        <div class="settings-section">
            <div class="card settings-card">
                <div class="card-body">
                    <h5 class="card-title">Account Settings</h5>
                    <form id="accountForm">
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" name="username" required 
                                title="Your username" placeholder="Enter your username">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Current Password</label>
                            <input type="password" class="form-control" name="currentPassword" 
                                title="Your current password" placeholder="Enter your current password">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">New Password</label>
                            <input type="password" class="form-control" name="newPassword" 
                                title="Your new password" placeholder="Enter your new password">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" name="confirmPassword" 
                                title="Confirm your new password" placeholder="Confirm your new password">
                        </div>
                        <button type="submit" class="btn btn-primary">Update Account</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Notification Settings -->
        <div class="settings-section">
            <div class="card settings-card">
                <div class="card-body">
                    <h5 class="card-title">Notification Settings</h5>
                    <form id="notificationForm">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="emailNotifications" name="emailNotifications">
                                <label class="form-check-label" for="emailNotifications">Email Notifications</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="taskReminders" name="taskReminders">
                                <label class="form-check-label" for="taskReminders">Task Reminders</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="projectUpdates" name="projectUpdates">
                                <label class="form-check-label" for="projectUpdates">Project Updates</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Notification Settings</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Display Settings -->
        <div class="settings-section">
            <div class="card settings-card">
                <div class="card-body">
                    <h5 class="card-title">Display Settings</h5>
                    <form id="displayForm">
                        <div class="mb-3">
                            <label class="form-label">Theme</label>
                            <select class="form-select" name="theme" title="Choose your preferred theme">
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                                <option value="system">System Default</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date Format</label>
                            <select class="form-select" name="dateFormat" title="Choose your preferred date format">
                                <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Time Format</label>
                            <select class="form-select" name="timeFormat" title="Choose your preferred time format">
                                <option value="12h">12-hour</option>
                                <option value="24h">24-hour</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Display Settings</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Danger Zone -->
        <div class="settings-section">
            <div class="card settings-card border-danger">
                <div class="card-body">
                    <h5 class="card-title text-danger">Danger Zone</h5>
                    <p class="text-muted">Once you delete your account, there is no going back. Please be certain.</p>
                    <button class="btn btn-danger" onclick="confirmDeleteAccount()">
                        <i class="bi bi-trash"></i> Delete Account
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return;
            }
            return token;
        }

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login';
        }

        // Add authorization header to all fetch requests
        function fetchWithAuth(url, options = {}) {
            const token = checkAuth();
            const headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`
            };

            return fetch(url, { ...options, headers })
                .then(response => {
                    if (response.status === 401) {
                        logout();
                        throw new Error('Unauthorized');
                    }
                    return response;
                });
        }

        // Load settings
        function loadSettings() {
            fetchWithAuth('/api/settings')
                .then(response => response.json())
                .then(settings => {
                    // Update notification settings
                    document.getElementById('emailNotifications').checked = settings.emailNotifications;
                    document.getElementById('taskReminders').checked = settings.taskReminders;
                    document.getElementById('projectUpdates').checked = settings.projectUpdates;

                    // Update display settings
                    document.querySelector('select[name="theme"]').value = settings.theme;
                    document.querySelector('select[name="dateFormat"]').value = settings.dateFormat;
                    document.querySelector('select[name="timeFormat"]').value = settings.timeFormat;
                })
                .catch(error => {
                    console.error('Error loading settings:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to load settings'
                    });
                });
        }

        // Handle account form submission
        document.getElementById('accountForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            if (data.newPassword && data.newPassword !== data.confirmPassword) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'New passwords do not match'
                });
                return;
            }

            fetchWithAuth('/api/settings/account', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: 'Account settings updated successfully',
                    timer: 2000,
                    showConfirmButton: false
                });
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'Failed to update account settings: ' + error.message
                });
            });
        });

        // Handle notification form submission
        document.getElementById('notificationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            fetchWithAuth('/api/settings/notifications', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: 'Notification settings updated successfully',
                    timer: 2000,
                    showConfirmButton: false
                });
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'Failed to update notification settings: ' + error.message
                });
            });
        });

        // Handle display form submission
        document.getElementById('displayForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            fetchWithAuth('/api/settings/display', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: 'Display settings updated successfully',
                    timer: 2000,
                    showConfirmButton: false
                });
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'Failed to update display settings: ' + error.message
                });
            });
        });

        // Confirm account deletion
        function confirmDeleteAccount() {
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete my account!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetchWithAuth('/api/settings/account', {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(() => {
                        Swal.fire({
                            icon: 'success',
                            title: 'Account Deleted!',
                            text: 'Your account has been deleted successfully.',
                            timer: 2000,
                            showConfirmButton: false
                        }).then(() => {
                            logout();
                        });
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: 'Failed to delete account: ' + error.message
                        });
                    });
                }
            });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
        });
    </script>
</body>
</html> 